Unit42
In this Sherlock, you will familiarize yourself with Sysmon logs and various useful EventIDs for identifying and analyzing malicious activities on a Windows system. Palo Alto's Unit42 recently conducted research on an UltraVNC campaign, wherein attackers utilized a backdoored version of UltraVNC to maintain access to systems. This lab is inspired by that campaign and guides participants through the initial access stage of the campaign.
Artifact given:
Microsoft-Windows-Sysmon-Operational.evtx

We need to parse it into XML format to be read, using python-evtx:
sudo apt update
sudo apt install python3 python3-pip
pip install python-evtx
Run:
Evtx_dump.py Microsoft-Windows-Sysmon-Operational.evtx > output.txt

How many Event logs are there with Event ID 11?
Ctrl+F the document and look for event ID 11 (use open output.txt)
Event code 11 meaning: File create operations are logged when a file is created or overwritten. This event is useful for monitoring autostart locations, like the Startup folder, as well as temporary and download directories, which are common places malware drops during initial infection.
Search for 11</EventID> - there should be 56 matches

Whenever a process is created in memory, an event with Event ID 1 is recorded with details such as command line, hashes, process path, parent process path, etc. This information is very useful for an analyst because it allows us to see all programs executed on a system, which means we can spot any malicious processes being executed. What is the malicious process that infected the victim's system?
Ctrl+F for <EventID Qualifiers="">1</EventID>
EventID Qualifiers="">1</EventID>
<Version>5</Version>
<Level>4</Level>
<Task>1</Task>
<Opcode>0</Opcode>
<Keywords>0x8000000000000000</Keywords>
<TimeCreated SystemTime="2024-02-14 03:41:56.559618"></TimeCreated>
<EventRecordID>118793</EventRecordID>
<Correlation ActivityID="" RelatedActivityID=""></Correlation>
<Execution ProcessID="3028" ThreadID="4412"></Execution>
<Channel>Microsoft-Windows-Sysmon/Operational</Channel>
<Computer>DESKTOP-887GK2L</Computer>
<Security UserID="S-1-5-18"></Security>
</System>
<EventData><Data Name="RuleName">technique_id=T1204,technique_name=User Execution</Data>
<Data Name="UtcTime">2024-02-14 03:41:56.538</Data>
<Data Name="ProcessGuid">{817bddf3-3684-65cc-2d02-000000001900}</Data>
<Data Name="ProcessId">10672</Data>
<Data Name="Image">C:\Users\CyberJunkie\Downloads\Preventivo24.02.14.exe.exe</Data>
<Data Name="FileVersion">1.1.2</Data>
<Data Name="Description">Photo and vn Installer</Data>
<Data Name="Product">Photo and vn</Data>
<Data Name="Company">Photo and Fax Vn</Data>
<Data Name="OriginalFileName">Fattura 2 2024.exe</Data>
<Data Name="CommandLine">"C:\Users\CyberJunkie\Downloads\Preventivo24.02.14.exe.exe" </Data>
<Data Name="CurrentDirectory">C:\Users\CyberJunkie\Downloads\</Data>
<Data Name="User">DESKTOP-887GK2L\CyberJunkie</Data>
<Data Name="LogonGuid">{817bddf3-311e-65cc-a7ae-1b0000000000}</Data>
Answer is: C:\Users\CyberJunkie\Downloads\Preventivo24.02.14.exe.exe

Which Cloud drive was used to distribute the malware?

<Events>
<Event xmlns="http://schemas.microsoft.com/win/2004/08/events/event"><System><Provider Name="Microsoft-Windows-Sysmon" Guid="{5770385f-c22a-43e0-bf4c-06f5698ffbd9}"></Provider>
<EventID Qualifiers="">22</EventID>
<Version>5</Version>
<Level>4</Level>
<Task>22</Task>
<Opcode>0</Opcode>
<Keywords>0x8000000000000000</Keywords>
<TimeCreated SystemTime="2024-02-14 03:41:26.444118"></TimeCreated>
<EventRecordID>118747</EventRecordID>
<Correlation ActivityID="" RelatedActivityID=""></Correlation>
<Execution ProcessID="3028" ThreadID="4452"></Execution>
<Channel>Microsoft-Windows-Sysmon/Operational</Channel>
<Computer>DESKTOP-887GK2L</Computer>
<Security UserID="S-1-5-18"></Security>
</System>
<EventData><Data Name="RuleName">-</Data>
<Data Name="UtcTime">2024-02-14 03:41:25.269</Data>
<Data Name="ProcessGuid">{817bddf3-3514-65cc-0802-000000001900}</Data>
<Data Name="ProcessId">4292</Data>
<Data Name="QueryName">uc2f030016253ec53f4953980a4e.dl.dropboxusercontent.com</Data>
<Data Name="QueryStatus">0</Data>
<Data Name="QueryResults">type:  5 edge-block-www-env.dropbox-dns.com;::ffff:162.125.81.15;198.51.44.6;2620:4d:4000:6259:7:6:0:1;198.51.45.6;2a00:edc0:6259:7:6::2;198.51.44.70;2620:4d:4000:6259:7:6:0:3;198.51.45.70;2a00:edc0:6259:7:6::4;</Data>
<Data Name="Image">C:\Program Files\Mozilla Firefox\firefox.exe</Data>
<Data Name="User">DESKTOP-887GK2L\CyberJunkie</Data>
</EventData>
</Event>

Dropbox was used to gain access to the malicious file

For many of the files it wrote to disk, the initial malicious file used a defense evasion technique called Time Stomping, where the file creation date is changed to make it appear older and blend in with other files. What was the timestamp changed to for the PDF file?
ðŸ”¹ Sysmon Event ID 2 â€“ File creation time changed
This event is specifically designed to detect time stomping.
Ctrl+ F for <EventID Qualifiers="">2</EventID>
<Event xmlns="http://schemas.microsoft.com/win/2004/08/events/event"><System><Provider Name="Microsoft-Windows-Sysmon" Guid="{5770385f-c22a-43e0-bf4c-06f5698ffbd9}"></Provider>
<EventID Qualifiers="">2</EventID>
<Version>5</Version>
<Level>4</Level>
<Task>2</Task>
<Opcode>0</Opcode>
<Keywords>0x8000000000000000</Keywords>
<TimeCreated SystemTime="2024-02-14 03:41:58.410145"></TimeCreated>
<EventRecordID>118850</EventRecordID>
<Correlation ActivityID="" RelatedActivityID=""></Correlation>
<Execution ProcessID="3028" ThreadID="4412"></Execution>
<Channel>Microsoft-Windows-Sysmon/Operational</Channel>
<Computer>DESKTOP-887GK2L</Computer>
<Security UserID="S-1-5-18"></Security>
</System>
<EventData><Data Name="RuleName">technique_id=T1070.006,technique_name=Timestomp</Data>
<Data Name="UtcTime">2024-02-14 03:41:58.404</Data>
<Data Name="ProcessGuid">{817bddf3-3684-65cc-2d02-000000001900}</Data>
<Data Name="ProcessId">10672</Data>
<Data Name="Image">C:\Users\CyberJunkie\Downloads\Preventivo24.02.14.exe.exe</Data>
<Data Name="TargetFilename">C:\Users\CyberJunkie\AppData\Roaming\Photo and Fax Vn\Photo and vn 1.1.2\install\F97891C\TempFolder\~.pdf</Data>
<Data Name="CreationUtcTime">2024-01-14 08:10:06.029</Data>
<Data Name="PreviousCreationUtcTime">2024-02-14 03:41:58.404</Data>
<Data Name="User">DESKTOP-887GK2L\CyberJunkie</Data>
</EventData>
</Event>
Answer was: 2024-01-14 08:10:06

The malicious file dropped a few files on disk. Where was "once.cmd" created on disk? Please answer with the full path along with the filename.

<Event xmlns="http://schemas.microsoft.com/win/2004/08/events/event"><System><Provider Name="Microsoft-Windows-Sysmon" Guid="{5770385f-c22a-43e0-bf4c-06f5698ffbd9}"></Provider>
<EventID Qualifiers="">11</EventID>
<Version>2</Version>
<Level>4</Level>
<Task>11</Task>
<Opcode>0</Opcode>
<Keywords>0x8000000000000000</Keywords>
<TimeCreated SystemTime="2024-02-14 03:41:58.407505"></TimeCreated>
<EventRecordID>118846</EventRecordID>
<Correlation ActivityID="" RelatedActivityID=""></Correlation>
<Execution ProcessID="3028" ThreadID="4412"></Execution>
<Channel>Microsoft-Windows-Sysmon/Operational</Channel>
<Computer>DESKTOP-887GK2L</Computer>
<Security UserID="S-1-5-18"></Security>
</System>
<EventData><Data Name="RuleName">-</Data>
<Data Name="UtcTime">2024-02-14 03:41:58.404</Data>
<Data Name="ProcessGuid">{817bddf3-3684-65cc-2d02-000000001900}</Data>
<Data Name="ProcessId">10672</Data>
<Data Name="Image">C:\Users\CyberJunkie\Downloads\Preventivo24.02.14.exe.exe</Data>
<Data Name="TargetFilename">C:\Users\CyberJunkie\AppData\Roaming\Photo and Fax Vn\Photo and vn 1.1.2\install\F97891C\WindowsVolume\Games\once.cmd</Data>
<Data Name="CreationUtcTime">2024-02-14 03:41:58.404</Data>
<Data Name="User">DESKTOP-887GK2L\CyberJunkie</Data>
</EventData>
</Event>
Answer: C:\Users\CyberJunkie\AppData\Roaming\Photo and Fax Vn\Photo and vn 1.1.2\install\F97891C\WindowsVolume\Games\once.cmd


The malicious file attempted to reach a dummy domain, most likely to check the internet connection status. What domain name did it try to connect to?
<Event xmlns="http://schemas.microsoft.com/win/2004/08/events/event"><System><Provider Name="Microsoft-Windows-Sysmon" Guid="{5770385f-c22a-43e0-bf4c-06f5698ffbd9}"></Provider>
<EventID Qualifiers="">22</EventID>
<Version>5</Version>
<Level>4</Level>
<Task>22</Task>
<Opcode>0</Opcode>
<Keywords>0x8000000000000000</Keywords>
<TimeCreated SystemTime="2024-02-14 03:41:58.764835"></TimeCreated>
<EventRecordID>118906</EventRecordID>
<Correlation ActivityID="" RelatedActivityID=""></Correlation>
<Execution ProcessID="3028" ThreadID="4452"></Execution>
<Channel>Microsoft-Windows-Sysmon/Operational</Channel>
<Computer>DESKTOP-887GK2L</Computer>
<Security UserID="S-1-5-18"></Security>
</System>
<EventData><Data Name="RuleName">-</Data>
<Data Name="UtcTime">2024-02-14 03:41:56.955</Data>
<Data Name="ProcessGuid">{817bddf3-3684-65cc-2d02-000000001900}</Data>
<Data Name="ProcessId">10672</Data>
<Data Name="QueryName">www.example.com</Data>
<Data Name="QueryStatus">0</Data>
<Data Name="QueryResults">::ffff:93.184.216.34;199.43.135.53;2001:500:8f::53;199.43.133.53;2001:500:8d::53;</Data>
<Data Name="Image">C:\Users\CyberJunkie\Downloads\Preventivo24.02.14.exe.exe</Data>
<Data Name="User">DESKTOP-887GK2L\CyberJunkie</Data>
</EventData>
</Event>

Query was to www.example.com

Which IP address did the malicious process try to reach out to?

Sysmon event code 3:
<Event xmlns="http://schemas.microsoft.com/win/2004/08/events/event"><System><Provider Name="Microsoft-Windows-Sysmon" Guid="{5770385f-c22a-43e0-bf4c-06f5698ffbd9}"></Provider>
<EventID Qualifiers="">3</EventID>
<Version>5</Version>
<Level>4</Level>
<Task>3</Task>
<Opcode>0</Opcode>
<Keywords>0x8000000000000000</Keywords>
<TimeCreated SystemTime="2024-02-14 03:41:58.905483"></TimeCreated>
<EventRecordID>118910</EventRecordID>
<Correlation ActivityID="" RelatedActivityID=""></Correlation>
<Execution ProcessID="3028" ThreadID="4424"></Execution>
<Channel>Microsoft-Windows-Sysmon/Operational</Channel>
<Computer>DESKTOP-887GK2L</Computer>
<Security UserID="S-1-5-18"></Security>
</System>
<EventData><Data Name="RuleName">technique_id=T1036,technique_name=Masquerading</Data>
<Data Name="UtcTime">2024-02-14 03:41:57.159</Data>
<Data Name="ProcessGuid">{817bddf3-3684-65cc-2d02-000000001900}</Data>
<Data Name="ProcessId">10672</Data>
<Data Name="Image">C:\Users\CyberJunkie\Downloads\Preventivo24.02.14.exe.exe</Data>
<Data Name="User">DESKTOP-887GK2L\CyberJunkie</Data>
<Data Name="Protocol">tcp</Data>
<Data Name="Initiated">True</Data>
<Data Name="SourceIsIpv6">False</Data>
<Data Name="SourceIp">172.17.79.132</Data>
<Data Name="SourceHostname">-</Data>
<Data Name="SourcePort">61177</Data>
<Data Name="SourcePortName">-</Data>
<Data Name="DestinationIsIpv6">False</Data>
<Data Name="DestinationIp">93.184.216.34</Data>
<Data Name="DestinationHostname">-</Data>
<Data Name="DestinationPort">80</Data>
<Data Name="DestinationPortName">-</Data>
</EventData>
</Event>
Answer is; 93.184.216.34

The malicious process terminated itself after infecting the PC with a backdoored variant of UltraVNC. When did the process terminate itself?

Process termination is event code 5
<Event xmlns="http://schemas.microsoft.com/win/2004/08/events/event"><System><Provider Name="Microsoft-Windows-Sysmon" Guid="{5770385f-c22a-43e0-bf4c-06f5698ffbd9}"></Provider>
<EventID Qualifiers="">5</EventID>
<Version>3</Version>
<Level>4</Level>
<Task>5</Task>
<Opcode>0</Opcode>
<Keywords>0x8000000000000000</Keywords>
<TimeCreated SystemTime="2024-02-14 03:41:58.799650"></TimeCreated>
<EventRecordID>118907</EventRecordID>
<Correlation ActivityID="" RelatedActivityID=""></Correlation>
<Execution ProcessID="3028" ThreadID="4412"></Execution>
<Channel>Microsoft-Windows-Sysmon/Operational</Channel>
<Computer>DESKTOP-887GK2L</Computer>
<Security UserID="S-1-5-18"></Security>
</System>
<EventData><Data Name="RuleName">-</Data>
<Data Name="UtcTime">2024-02-14 03:41:58.795</Data>
<Data Name="ProcessGuid">{817bddf3-3684-65cc-2d02-000000001900}</Data>
<Data Name="ProcessId">10672</Data>
<Data Name="Image">C:\Users\CyberJunkie\Downloads\Preventivo24.02.14.exe.exe</Data>
<Data Name="User">DESKTOP-887GK2L\CyberJunkie</Data>
</EventData>
</Event>

Sherlock completed
